<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Q-Learning - HackaGames</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
        <link href="../../style.css" rel="stylesheet">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">HackaGames</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../../.." class="nav-link">ktorz <</a>
                            </li>
                            <li class="navitem">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">First-Steps <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../hello/install/" class="dropdown-item">Install</a>
</li>
                                    
<li>
    <a href="../../hello/first-bot/" class="dropdown-item">First Bot</a>
</li>
                                    
<li>
    <a href="../../hello/multi-player/" class="dropdown-item">Multi-Player</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Games <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../games/py421/" class="dropdown-item">Py4.2.1</a>
</li>
                                    
<li>
    <a href="../../games/connect4/" class="dropdown-item">Connect4</a>
</li>
                                    
<li>
    <a href="../../games/tictactoe/" class="dropdown-item">TicTacToe</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Learnning <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../policy/" class="dropdown-item">Policy</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">Q-Learning</a>
</li>
                                    
<li>
    <a href="../learn-model/" class="dropdown-item">Learn Model</a>
</li>
                                    
<li>
    <a href="../decision-tree/" class="dropdown-item">Decision Tree</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Under the hood <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../hood/api/" class="dropdown-item">Protocol API</a>
</li>
                                    
<li>
    <a href="../../hood/pod.md" class="dropdown-item">Pod Class</a>
</li>
                                    
<li>
    <a href="../../hood/newgame/" class="dropdown-item">New Game</a>
</li>
                                    
<li>
    <a href="../../hood/testdriven/" class="dropdown-item">Test-Driven</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../../f.a.q/" class="nav-link">F.A.Q</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../policy/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../learn-model/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#basic-reinforcement-learning-q-learning" class="nav-link">Basic Reinforcement Learning: Q-Learning</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#q-values-equation" class="nav-link">Q-Values equation</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#implementing-q-values" class="nav-link">Implementing Q-Values</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#when-to-update-q-values" class="nav-link">When to update Q-Values ?</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#exploration-exploitation-dilemma" class="nav-link">Exploration-Exploitation Dilemma</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#experiments" class="nav-link">Experiments</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#going-further" class="nav-link">Going further</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="basic-reinforcement-learning-q-learning">Basic Reinforcement Learning: Q-Learning</h1>
<p>Reinforcement Learning is a family of approaches and algorithms that enhance an autonomous system (an agent) to learn from it successful tries and failures [Cf. <a href="https://en.wikipedia.org/wiki/Reinforcement_learning">Wikipedia</a>].
Technically, at the beginning, the agent is capable of acting in it environment (with default pure random action for instance) 
and by acting it gets feedback.
Accumulating feedback, it will be capable of evaluating the interest of actions in a given context.</p>
<p>In reinforcement Learning family, <strong>Q-Learning</strong> is quite a simple and apply pretty well for learning to play <strong>421</strong>.</p>
<p>The goal of the tutorial: </p>
<ol>
<li>Implement a new <code>qlearnerBot</code> player from random <em>Bot</em>.</li>
<li>At initialization <code>qvalues</code> is created empty with the other required variables.</li>
<li>At perception steps the bot updates its <code>qvalues</code> </li>
<li>At decision steps it chooses a new action to perform.</li>
</ol>
<p>And do not forget: you ~~can~~ must test your code at each development step by executing the code for a few games and validate that the output is as expected (also a good python tool to make test: <code>pytest</code>).</p>
<h2 id="q-values-equation">Q-Values equation</h2>
<p>The <strong>Q-Learning</strong> algorithm ([Cf. <a href="https://en.wikipedia.org/wiki/Q-learning">Wikipedia</a>]) consists of computing <code>qvalues</code>, a dictionary of interests/values of executing a given action from a given state.</p>
<div class="arithmatex">\[ \mathit{qvalues}(s, a) \in \mathbb{R} \]</div>
<p>A <em>Q-Value</em> is equal to the immediate reward of doing action <span class="arithmatex">\(a\)</span> in a state <span class="arithmatex">\(s\)</span> plus the future rewards modeled as <span class="arithmatex">\(\mathit{qvalues}(s', a')\)</span>.
<span class="arithmatex">\(s'\)</span> is the state reached from (s, a) and <span class="arithmatex">\(a'\)</span> the next action that will be performed.
In other terms, <span class="arithmatex">\(\mathit{qvalues}(s, a)\)</span> is the cumulative reward from <span class="arithmatex">\(s\)</span>, knowing that the next action is <span class="arithmatex">\(a\)</span>.
However, the resulting experiment of doing <span class="arithmatex">\(a\)</span> from <span class="arithmatex">\(s\)</span> need to be computed as an average.</p>
<p>Finally, one of the ways to formalize updates on <span class="arithmatex">\(\mathit{qvalues}(s, a)\)</span> is:</p>
<div class="arithmatex">\[ \mathit{qvalues}(s, a) = \alpha \times \mathit{experience} + (1-\alpha)\times \mathit{qvalues}(s, a)\]</div>
<div class="arithmatex">\[ \text{with:}\ \mathit{experience}= r(s, a, s') + \max_{a'\in A}(\ \mathit{qvalues}(s', a')\ ) \]</div>
<p>The learning rate <span class="arithmatex">\(\alpha\)</span> is the speed that incoming experiences erase the oldest (can be initialized at <span class="arithmatex">\(0.1\)</span> as a first approximation).</p>
<h2 id="implementing-q-values">Implementing Q-Values</h2>
<p>At some point, our new <em>Bot</em> (defined in <code>qlearnerBot.py</code>) will require to update its <code>qvalues</code> from its experiments.
So let's start with a method:</p>
<pre><code class="language-python">def updateQvalues(self, previous_state, action, current_state, reward):
    ...
</code></pre>
<p>A simple way to implement <code>qvalues</code> in python language is to implement it as a Dictionnary of dictionaries
(expected result: <code>qvalues['state']['action'] -&gt; the interest of doing 'action' in 'state'</code>).</p>
<p>But first: initializing empty <code>qvalues</code> will look like:</p>
<pre><code class="language-python">qvalues= {}
</code></pre>
<p>Typically in the constructor method <code>__init__</code> in python (and with Q-Learning attributes):</p>
<pre><code class="language-python">class Bot :
    def __init__(self):
        self._alpha= 0.1 # learning rate, speed that an incoming experience erases the oldest.
        self._qvalues= { &quot;wakeUp&quot;: {&quot;roll-roll-roll&quot;: 0.0} }
</code></pre>
<p>Returning to the <code>updateQvalues</code> method,
initializing action values for a given state will lookalike</p>
<pre><code class="language-python"># state= &quot;2|6-3-1&quot; for instance (2 re-rolls from dice: 6, 3 and 1)
if state not in self.qvalues.keys() :
    self._qvalues[state]= {
            &quot;keep-keep-keep&quot;:0.0, &quot;roll-keep-keep&quot;:0.0, &quot;keep-roll-keep&quot;:0.0,
            &quot;roll-roll-keep&quot;:0.0, &quot;keep-keep-roll&quot;:0.0, &quot;roll-keep-roll&quot;:0.0,
            &quot;keep-roll-roll&quot;:0.0, &quot;roll-roll-roll&quot;:0.0 }
</code></pre>
<p>Finally, modifying a value in <strong>qvalues</strong> will look lookalike</p>
<pre><code class="language-python">self._qvalues[&quot;2|6-3-1&quot;][&quot;roll-roll-roll&quot;]= ...
</code></pre>
<h2 id="when-to-update-q-values">When to update Q-Values ?</h2>
<p>The <code>updateQvalues</code> method requires to confront previous and current states
It can be performed while a new state is reaches.
So, call to <code>updateQvalues</code> can be implemented into <code>perception</code> method.
The reward can be computed as the difference between previous and current score.
Do not forget to initialize state and action in <code>wakeUp</code> method.</p>
<p>Your <em>Bot</em> player interface methods should be:</p>
<pre><code class="language-python">    def wakeUp(self, playerId, numberOfPlayers, gameConf):
        self._state= &quot;wakeUp&quot;
        self._action= &quot;roll-roll-roll&quot;
        self._score= 0

    def perceive(self, gameState):
        self._horizon= gameState.child(1).flag(1)
        self._dices= gameState.child(2).flags()
        newScore= gameState.child(2).value(1)
        # Learn:
        newState= f&quot;{self._horizon}|{self._dices[0]}-{self._dices[1]}-{self._dices[2]}&quot;
        self.updateQvalues(
            self._state, self._action,
            newState, newScore-self._score
        )
        # Switch:
        self._state= newState
        self._score= newScore
</code></pre>
<h2 id="exploration-exploitation-dilemma">Exploration-Exploitation Dilemma</h2>
<p>Until now we just compute and record statistical rewards. 
The idea is to use-it on to take <em>decision</em> at some time (i.e. when we record a good knowledge).
However the first difficulty in reinforcement learning result in the definition of this "at some time".
In other terms, when to stop the computation of statistical kwonledge by exploring actions and to start the exploitation of computed statistics to make decisions.
It is known as the exploration versus exploitation trade-off [cf. <a href="https://en.wikipedia.org/wiki/Reinforcement_learning#Exploration">wikipedia</a>].</p>
<p>One way to overpass the trade-off is to put it random. 
The <em>ε-greedy</em> heuristic suppose that you will choose an exploration action (i.e. a random action for instance) a few times in a given time step.
More technically, at each time step the AI randomly choose to get a random action or to get the best one accordingly to the current knowledge.
The random chose to explore versus to exploit is weighted by <code>ε</code> and <code>1-ε</code> with <code>ε</code> between 1 and 0.</p>
<p>Do not forget to initialize the <code>self._epsilon</code> in the constructor method (<code>self._epsilon= 0.1</code> is generally a good first value, it states that a random action would be chosen 1 time over 10).</p>
<h2 id="experiments">Experiments</h2>
<p>You can now try to answer the question: how many episodes are required to learn a good enough policy.</p>
<p>One way to do that is to plot the evolution of the strategy during the learning.
For instance, the package <a href="https://matplotlib.org/stable/tutorials/introductory/pyplot.html">pyplot</a> provides tools to do that.
At the end of a series of games, it would be more interesting to plot the evolution of the average score rather to compute a unique average.</p>
<p>Let generate a plot with one points every <span class="arithmatex">\(500\)</span> games for instance at sleep time.</p>
<pre><code class="language-python">import matplotlib.pyplot as plt

...

    def __init__(self):
        # Progress
        self._results= []
        self._evals= []
        # Q-Learning attributes
        self._qvalues= { &quot;wakeUp&quot;: {&quot;roll-roll-roll&quot;: 0.0} }
        self._alpha= 0.1
        self._epsilon= 0.1

...

    def sleep(self, result):
        self._results.append(result)
        if len(self._results) == 500 :
            self._evals.append( sum(self._results)/500.0 )
            self._results= []
            self.drawEvaluations()

    def drawEvaluations(self) :
        plt.plot( 
            [ i*500 for i in range(len(self._evals)) ],
            self._evals )
        plt.savefig( &quot;output.png&quot; )
        plt.clf()
</code></pre>
<h2 id="going-further">Going further</h2>
<p>Greedy exploit/Explore ratio is limited, notably when the Q-values become stables.
A first solution is to change the ratio dynamically while the systems record experiments.
Another solution consists of implementing <a href="https://en.wikipedia.org/wiki/Reinforcement_learning#policy">probabilistic policies</a>.</p>
<p>Using probabilistic policies in <em>Q-Learning</em> the probability to take an action rather than another increase with the differences in <em>Q-Values</em>.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/jquery-3.6.0.min.js"></script>
        <script src="../../js/bootstrap.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../javascripts/mathjax.js"></script>
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
